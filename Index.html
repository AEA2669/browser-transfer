<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat & Transfer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; color: #1c1e21; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .status-box { background: #e7f3ff; color: #0c59db; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; text-align: center; }
        
        /* Chat UI */
        #chat-window { height: 300px; border: 1px solid #ddd; border-radius: 8px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #fafafa; display: flex; flex-direction: column; }
        .msg { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 0.9rem; }
        .msg.me { align-self: flex-end; background: #0084ff; color: white; }
        .msg.them { align-self: flex-start; background: #e4e6eb; color: black; }
        
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        
        button { padding: 10px 15px; background: #24292e; color: white; border: none; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #444; }
        #send-file-btn { background: #28a745; width: 100%; border-radius: 8px; margin-top: 5px; }
        
        #interaction-area { display: none; border-top: 1px solid #eee; pt: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center;">P2P Transfer</h2>
    
    <div class="status-box">
        Your ID: <span id="my-id">Connecting...</span>
    </div>

    <div id="setup-area">
        <div class="input-group">
            <input type="text" id="peer-id-input" placeholder="Paste Friend's ID">
            <button id="connect-btn">Connect</button>
        </div>
    </div>

    <div id="interaction-area">
        <div id="chat-window"></div>
        
        <div class="input-group">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button id="send-msg-btn">Send</button>
        </div>

        <div style="border-top: 1px solid #eee; padding-top: 10px;">
            <input type="file" id="file-input" style="font-size: 0.8rem;">
            <button id="send-file-btn">Upload & Send File</button>
        </div>
    </div>
</div>

<script>
    const peer = new Peer();
    let conn;

    const chatWindow = document.getElementById('chat-window');
    const chatInput = document.getElementById('chat-input');
    const myIdDisplay = document.getElementById('my-id');

    // Display your Peer ID
    peer.on('open', (id) => {
        myIdDisplay.innerText = id;
    });

    // Handle incoming connections
    peer.on('connection', (incoming) => {
        conn = incoming;
        ready();
    });

    // Connect to a peer
    document.getElementById('connect-btn').onclick = () => {
        const remoteId = document.getElementById('peer-id-input').value;
        conn = peer.connect(remoteId);
        ready();
    };

    function ready() {
        conn.on('open', () => {
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('interaction-area').style.display = 'block';
            addMessage("System", "Connected to peer!", "them");
        });

        conn.on('data', (data) => {
            if (data.type === 'chat') {
                addMessage("Peer", data.body, "them");
            } else if (data.type === 'file') {
                const blob = new Blob([data.file], { type: data.fileType });
                const url = URL.createObjectURL(blob);
                addMessage("System", `Received file: <a href="${url}" download="${data.fileName}">${data.fileName}</a>`, "them");
            }
        });
    }

    // Send Text Message
    function sendChatMessage() {
        const msg = chatInput.value;
        if (msg && conn && conn.open) {
            conn.send({ type: 'chat', body: msg });
            addMessage("Me", msg, "me");
            chatInput.value = "";
        }
    }

    document.getElementById('send-msg-btn').onclick = sendChatMessage;
    chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendChatMessage(); };

    // Send File
    document.getElementById('send-file-btn').onclick = () => {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (file && conn && conn.open) {
            conn.send({
                type: 'file',
                file: file,
                fileName: file.name,
                fileType: file.type
            });
            addMessage("Me", `Sent file: ${file.name}`, "me");
        }
    };

    function addMessage(user, text, className) {
        const div = document.createElement('div');
        div.className = `msg ${className}`;
        div.innerHTML = `<strong>${user}:</strong> ${text}`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
</script>

</body>
</html>
